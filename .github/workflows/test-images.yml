name: üõ†Ô∏è Test images
on:
  # Don't test on pushes or pull requests to main.
  # The build and release has its own set of tests.
  push:
    paths:
      - '!.github/**'
      - '!config-scripts/**'
      - '!README.md'
    branches-ignore:
      - main
  pull_request:
    paths:
      - '!.github/**'
      - '!config-scripts/**'
      - '!README.md'
    branches-ignore:
      - main
jobs:

  set-constants:
    name: üî† Setting workflow constants
    runs-on: ubuntu-24.04
    outputs:
      FLAVORS: '[ "f", "r", "s" ]'
      VERSIONS: '[ "23.9", "23.26.0" ]'
      LATEST_VERSION: "23.26.0"
      RPM_ARCH: '[ "aarch64", "x86_64" ]'
      IMAGE_ARCH: '[ "arm64", "amd64" ]'
    steps:
      - run: echo "setting constants"

  download-install-files:
    name: ‚¨áÔ∏è Download install binaries
    environment: build
    runs-on: ubuntu-24.04
    needs: set-constants
    strategy:
      matrix:
        versions: ${{ fromJSON(needs.set-constants.outputs.VERSIONS) }}
        arch: ${{ fromJSON(needs.set-constants.outputs.RPM_ARCH) }}
    steps:
      - name: üîç Determine RPM file name
        run: |
          # Retrieve the version being built
          VERSION="${{ matrix.versions }}"
          if [ "${#VERSION}" == 4 ]; then
            DATABASE_NAME="oracle-database-free-23ai"
          else
            DATABASE_NAME="oracle-ai-database-free-26ai"
          fi;
          echo "DATABASE_NAME=${DATABASE_NAME}" >> "$GITHUB_ENV"

      - name: ‚¨áÔ∏è Download install file from web
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.FILE_SERVER }} >> ~/.ssh/known_hosts 2>/dev/null
          eval $(ssh-agent)
          ssh-add - <<< "${{ secrets.FILE_USER_AUTH }}"
          scp ${{ secrets.FILE_USER }}@${{ secrets.FILE_SERVER }}:"${{ env.DATABASE_NAME }}-${{ matrix.versions }}-1.el8.${{ matrix.arch }}.rpm" .

      - name: üíæ Store install file
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: ${{ env.DATABASE_NAME }}-${{ matrix.versions }}-1.el8.${{ matrix.arch }}.rpm
          path: ${{ env.DATABASE_NAME }}-${{ matrix.versions }}-1.el8.${{ matrix.arch }}.rpm

  build-and-test-images:
    name: üõ†Ô∏è üî¨ Build and test images
    runs-on: ${{ matrix.os }}
    environment: build
    needs: [ set-constants, download-install-files ]
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
        versions: ${{ fromJSON(needs.set-constants.outputs.VERSIONS) }}
        flavors: ${{ fromJSON(needs.set-constants.outputs.FLAVORS) }}
    steps:
      - name: üßπ Cleanup runner
        run: |
          # Remove Java (JDKs)
          sudo rm -rf /usr/lib/jvm

          # Remove .NET SDKs
          sudo rm -rf /usr/share/dotnet

          # Remove Swift toolchain
          sudo rm -rf /usr/share/swift

          # Remove Haskell (GHC)
          sudo rm -rf /usr/local/.ghcup

          # Remove Julia
          sudo rm -rf /usr/local/julia*

          # Remove Chromium (optional if not using for browser tests)
          sudo rm -rf /usr/local/share/chromium

          # Remove Microsoft/Edge and Google Chrome builds
          sudo rm -rf /opt/microsoft /opt/google

          # Remove Azure CLI
          sudo rm -rf /opt/az

      - name: üìÇ Checkout repo
        uses: actions/checkout@v4

      - name: üîÑ Generate environment variables
        id: env_vars
        run: |
          if     [ "${{ matrix.flavors }}" == "f" ]; then image_flavor="-full";
            elif [ "${{ matrix.flavors }}" == "r" ]; then image_flavor="";
            elif [ "${{ matrix.flavors }}" == "s" ]; then image_flavor="-slim";
            else image_flavor="";
          fi;
          echo "IMAGE_FLAVOR=$image_flavor" >> "$GITHUB_OUTPUT"
          os_arch=$(uname -m)
          if     [ "${os_arch}" == "aarch64" ]; then image_arch="arm64";
            elif [ "${os_arch}" == "x86_64" ];  then image_arch="amd64";
            else image_arch="";
          fi;
          echo "IMAGE_ARCH=$image_arch" >> "$GITHUB_OUTPUT"
          echo "OS_ARCH=$os_arch" >> "$GITHUB_OUTPUT"

          # Retrieve the version being built
          VERSION="${{ matrix.versions }}"
          if [ "${#VERSION}" == 4 ]; then
            DATABASE_NAME="oracle-database-free-23ai"
          else
            DATABASE_NAME="oracle-ai-database-free-26ai"
          fi;
          echo "DATABASE_NAME=${DATABASE_NAME}" >> "$GITHUB_ENV"

      - name: ‚¨áÔ∏è Download stored install file
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.DATABASE_NAME }}-${{ matrix.versions }}-1.el8.${{ steps.env_vars.outputs.OS_ARCH }}.rpm

      - name: üõ†Ô∏è Build container image for ${{ matrix.versions }}, flavor "${{ matrix.flavors }}"
        run: ./buildContainerImage.sh -v "${{ matrix.versions }}" -${{ matrix.flavors }}

      - name: üßπ Cleanup build rpm
        run: rm ${{ env.DATABASE_NAME }}-${{ matrix.versions }}-1.el8.${{ steps.env_vars.outputs.OS_ARCH }}.rpm

      - name: üõ†Ô∏è Build faststart container image for ${{ matrix.versions }}, flavor "${{ matrix.flavors }}"
        run: ./buildContainerImage.sh -i -v "${{ matrix.versions }}" -${{ matrix.flavors }} -x

      - name: üî¨ Test images
        env:
          IMAGE_FLAVOR: ${{ steps.env_vars.outputs.IMAGE_FLAVOR }}
          IMAGE_ARCH: ${{ steps.env_vars.outputs.IMAGE_ARCH }}
        run: |
          cd tests
          ./test-container.sh "gvenzl/oracle-free:${{ matrix.versions }}${IMAGE_FLAVOR}-${IMAGE_ARCH}"
          ./test-container.sh "gvenzl/oracle-free:${{ matrix.versions }}${IMAGE_FLAVOR}-faststart-${IMAGE_ARCH}"
